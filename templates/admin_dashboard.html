{% extends 'dashboard_base.html' %}
{% block content %}
<div class="p-6 space-y-6">

  <!-- METRIC CARDS -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
    <div class="bg-gray-800 p-5 rounded-lg shadow flex items-center">
      <i class="fas fa-users text-3xl text-teal-400"></i>
      <div class="ml-4">
        <p id="totalPatients" class="text-2xl font-semibold">–</p>
        <p class="text-gray-400">Total Patients</p>
      </div>
    </div>
    <div class="bg-gray-800 p-5 rounded-lg shadow flex items-center">
      <i class="fas fa-user-clock text-3xl text-yellow-400"></i>
      <div class="ml-4">
        <p id="newWeek" class="text-2xl font-semibold">–</p>
        <p class="text-gray-400">New This Week</p>
      </div>
    </div>
    <div class="bg-gray-800 p-5 rounded-lg shadow flex items-center">
      <i class="fas fa-hourglass-half text-3xl text-orange-400"></i>
      <div class="ml-4">
        <p id="pendingDX" class="text-2xl font-semibold">–</p>
        <p class="text-gray-400">Pending Diagnoses</p>
      </div>
    </div>
    <div class="bg-gray-800 p-5 rounded-lg shadow flex items-center">
      <i class="fas fa-check-circle text-3xl text-green-400"></i>
      <div class="ml-4">
        <p id="completedDX" class="text-2xl font-semibold">–</p>
        <p class="text-gray-400">Completed Diagnoses</p>
      </div>
    </div>
  </div>

  <!-- CHART & STAFF ON DUTY -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Diagnosis Breakdown -->
    <div class="bg-gray-800 p-5 rounded-lg shadow lg:col-span-2">
      <h2 class="text-xl font-semibold text-white mb-4">Diagnosis Breakdown</h2>
      <canvas id="dxChart" class="w-full h-64"></canvas>
    </div>
    <!-- Staff On Duty -->
    <div class="bg-gray-800 p-5 rounded-lg shadow">
      <h2 class="text-xl font-semibold text-white mb-4">Staff On Duty</h2>
      <ul id="staffList" class="space-y-4">
        <!-- filled by JS -->
      </ul>
    </div>
  </div>

  <!-- PENDING TABLE & RECENT -->
  <!-- you can similarly give IDs to these sections for JS updating -->

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const statsUrl = "{% url 'api_admin_stats' %}";

  async function fetchAdminStats(){
    const resp = await fetch(statsUrl);
    const data = await resp.json();

    document.getElementById('totalPatients').innerText = data.total_patients;
    document.getElementById('newWeek').innerText       = data.new_patients_week;
    document.getElementById('pendingDX').innerText     = data.pending_diagnoses;
    document.getElementById('completedDX').innerText   = data.completed_diagnoses;

    // rebuild staff list
    const staffUl = document.getElementById('staffList');
    staffUl.innerHTML = '';
    data.staff_on_duty.forEach(s => {
      const li = document.createElement('li');
      li.className = 'flex items-center space-x-3';
      li.innerHTML = `
        <div class="h-8 w-8 bg-gray-600 rounded-full flex items-center justify-center text-gray-300">
          <i class="fas fa-user"></i>
        </div>
        <div>
          <p class="text-white">${s.username}</p>
        </div>`;
      staffUl.appendChild(li);
    });

    // update chart
    dxChart.data.datasets[0].data = [
      data.normals_count,
      data.ptb_count,
      data.pending_diagnoses
    ];
    dxChart.update();
  }

  // initialize chart
  const ctx = document.getElementById('dxChart').getContext('2d');
  const dxChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Normal','PTB','Pending'],
      datasets: [{
        data: [0,0,0],
      }]
    },
    options: { responsive: true }
  });

  // first load + poll every 30s
  fetchAdminStats();
  setInterval(fetchAdminStats, 30000);
</script>
{% endblock %}
